<script>
    const API_URL   = 'https://script.google.com/macros/s/AKfycbzaSRjrP1bfjWgqiiWrOECu169sxqOoGAKRVRGZcSqW5pRwk461eDSxCfvsgKCTQFzi/exec';
    const API_TOKEN = 'JkiZwfLFSO3MbBNWdCJOhJHgtgI0EJUFZOifVcU9sXbHoGFhrb0nopePh8jRwJF7';

    // Carrega o estado das parcelas da planilha (via Apps Script)
    async function loadPaymentStatus() {
        try {
            const res = await fetch(`${API_URL}?token=${API_TOKEN}`, {
                method: 'GET'
            });

            if (!res.ok) {
                console.error('Erro ao carregar status das parcelas');
                return;
            }

            const data = await res.json();
            const status = data.paidInstallments || [];

            status.forEach(installmentNum => {
                const element = document.querySelector(`[data-installment="${installmentNum}"]`);
                if (element) {
                    element.classList.add('paid');
                    const payBtn = element.querySelector('.pay-button');
                    const unpayBtn = element.querySelector('.unpay-button');
                    if (payBtn) payBtn.style.display = 'none';
                    if (unpayBtn) unpayBtn.style.display = 'inline-block';
                }
            });

            updateSummary();
        } catch (err) {
            console.error('Erro na requisição de loadPaymentStatus:', err);
        }
    }

    // Salva o estado atual das parcelas na planilha (via Apps Script)
    async function savePaymentStatus() {
        const paidInstallments = [];
        document.querySelectorAll('.installment.paid').forEach(el => {
            paidInstallments.push(parseInt(el.dataset.installment));
        });

        try {
            const res = await fetch(`${API_URL}?token=${API_TOKEN}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ paidInstallments })
            });

            if (!res.ok) {
                console.error('Erro ao salvar status das parcelas');
            }
        } catch (err) {
            console.error('Erro na requisição de savePaymentStatus:', err);
        }
    }

    // Marca uma parcela como paga (usado nos onclick do HTML)
    async function markAsPaid(installmentNum) {
        const element = document.querySelector(`[data-installment="${installmentNum}"]`);
        if (!element) return;

        element.classList.add('paid');
        
        const payBtn = element.querySelector('.pay-button');
        const unpayBtn = element.querySelector('.unpay-button');
        if (payBtn) payBtn.style.display = 'none';
        if (unpayBtn) unpayBtn.style.display = 'inline-block';
        
        updateSummary();
        await savePaymentStatus();
    }

    // Desmarca uma parcela como paga (usado nos onclick do HTML)
    async function markAsUnpaid(installmentNum) {
        const element = document.querySelector(`[data-installment="${installmentNum}"]`);
        if (!element) return;

        element.classList.remove('paid');
        
        const payBtn = element.querySelector('.pay-button');
        const unpayBtn = element.querySelector('.unpay-button');
        if (payBtn) payBtn.style.display = 'inline-block';
        if (unpayBtn) unpayBtn.style.display = 'none';
        
        updateSummary();
        await savePaymentStatus();
    }

    // Atualiza o resumo de parcelas
    function updateSummary() {
        const paidInstallments = document.querySelectorAll('.installment.paid');
        const paidCount = paidInstallments.length;
        const totalInstallments = document.querySelectorAll('.installment').length;
        const pendingCount = totalInstallments - paidCount;
        
        let totalPaid = 0;
        paidInstallments.forEach(el => {
            totalPaid += parseFloat(el.dataset.value);
        });
        
        document.getElementById('paidCount').textContent = paidCount;
        document.getElementById('pendingCount').textContent = pendingCount;
        document.getElementById('totalPaid').textContent = `R$ ${totalPaid.toFixed(2).replace('.', ',')}`;
    }

    // Modo admin com senha
    document.getElementById('adminMode').addEventListener('change', function() {
        if (this.checked) {
            const senha = prompt('Digite a senha de administrador:');
            
            if (senha === 'MS-parcela-wevertton8x') {
                const controls = document.querySelectorAll('.admin-controls');
                controls.forEach(control => {
                    control.classList.add('active');
                });
            } else {
                alert('Senha incorreta! Acesso negado.');
                this.checked = false;
            }
        } else {
            const controls = document.querySelectorAll('.admin-controls');
            controls.forEach(control => {
                control.classList.remove('active');
            });
        }
    });

    // Quando a página carrega, busca o status na planilha
    window.addEventListener('DOMContentLoaded', loadPaymentStatus);
</script>
